generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============ Core Tables ============

model clients {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  contact_name       String?
  contact_email      String?
  avatar_url         String?
  avatar_color       String?   @db.VarChar(7)
  growth_stage       String?   // 'seedling', 'sprouting', 'blooming', 'harvesting'
  stage_updated_at   DateTime? @db.Timestamptz(6)
  performance_score  Int?      // Cached score 0-100
  score_updated_at   DateTime? @db.Timestamptz(6)
  status             String?   @default("active")
  monthly_spend      Decimal?  @default(0) @db.Decimal
  start_date         DateTime? @db.Date
  highlevel_id              String?
  basecamp_id               String?
  basecamp_project_id       String?
  stripe_customer_id        String?
  agency_dashboard_share_key String?
  landingsite_preview_url   String?
  website_url               String?   @db.VarChar(500)
  hosting_type              String?   @db.VarChar(50) // 'ai_site', 'pyrus_hosted', 'client_hosted'
  hosting_provider          String?   @db.VarChar(100) // e.g., 'HubSpot', 'Wix', 'Squarespace'
  website_provider          String?   @db.VarChar(20)  // 'pear' | 'other' | null - who built the website
  website_launch_date       DateTime? @db.Date
  uptimerobot_monitor_id    String?   @db.VarChar(50)
  notes                     String?
  referred_by               String?
  referral_source           String?
  onboarding_completed_at   DateTime? @db.Timestamptz(6)
  // Content approval workflow settings
  content_approval_mode     String?   @default("full_approval") // 'full_approval', 'initial_approval', 'auto'
  approval_threshold        Int?      // Number of pieces to approve before auto-approving (for initial_approval mode)
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  updated_at         DateTime? @default(now()) @db.Timestamptz(6)

  profiles              profiles[]
  activity_log          activity_log[]
  content               content[]
  recommendations       recommendations[]
  smart_recommendations smart_recommendations[]
  revenue_records       revenue_records[]
  subscriptions         subscriptions[]
  checklist_items       client_checklist_items[]
  onboarding_responses  client_onboarding_responses[]
  communications        client_communications[]
  basecamp_activities   basecamp_activities[]
  client_products       client_products[]
  metric_snapshots      metric_snapshots[]
  keyword_rankings      keyword_rankings[]
  leads                 leads[]
  ai_visibility_scores  ai_visibility_scores[]
  client_alerts         client_alerts[]
  score_history         score_history[]
  website_edit_requests website_edit_requests[]
  system_alerts         system_alerts[]
  activity_feed         activity_feed[]
}

// Centralized activity log for all significant portal activities
model activity_feed {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id     String?   @db.Uuid
  user_id       String?   @db.Uuid
  user_name     String
  activity_type String
  message       String
  metadata      Json?     @default("{}")
  icon          String?   @default("info")
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  client clients? @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([created_at(sort: Desc)])
  @@index([activity_type])
  @@index([user_id])
  @@index([client_id, created_at(sort: Desc)])
}

// Manual product assignments (for clients not going through purchase flow)
model client_products {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id     String    @db.Uuid
  product_id    String    @db.Uuid
  monthly_price Decimal?  @db.Decimal  // Override price (null = use product default)
  notes         String?
  assigned_by   String?   @db.Uuid  // Profile ID of admin who assigned
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  client  clients  @relation(fields: [client_id], references: [id], onDelete: Cascade)
  product products @relation(fields: [product_id], references: [id], onDelete: Cascade)

  @@unique([client_id, product_id])
  @@index([client_id])
}

model profiles {
  id         String    @id @db.Uuid
  email      String    @unique
  full_name  String?
  avatar_url String?
  role       String
  client_id  String?   @db.Uuid
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)

  client            clients?            @relation(fields: [client_id], references: [id])
  activity_log      activity_log[]
  content_authored  content[]           @relation("content_author")
  content_assigned  content[]           @relation("content_assigned")
  content_comments  content_comments[]
  content_revisions content_revisions[]
  notifications     notifications[]
  recommendations   recommendations[]
  user_invites      user_invites[]
}

model user_invites {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email         String
  full_name     String?
  phone         String?
  role          String    // 'client', 'admin', 'super_admin', 'production_team', 'sales'
  client_ids    String[]  @default([]) @db.Uuid // Array of client IDs for client users
  invite_token  String    @unique
  status        String    @default("pending") // 'pending', 'accepted', 'expired'
  invited_by    String?   @db.Uuid
  sent_at       DateTime? @db.Timestamptz(6)
  expires_at    DateTime  @db.Timestamptz(6)
  accepted_at   DateTime? @db.Timestamptz(6)
  created_at    DateTime  @default(now()) @db.Timestamptz(6)

  inviter     profiles?  @relation(fields: [invited_by], references: [id])
}

// ============ Products & Bundles ============

model products {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String
  short_description       String?
  long_description        String?
  category                String
  monthly_price           Decimal?  @db.Decimal
  onetime_price           Decimal?  @db.Decimal
  stripe_product_id       String?
  stripe_monthly_price_id String?
  stripe_onetime_price_id String?
  supports_quantity       Boolean?  @default(false)
  status                  String?   @default("active")
  sort_order              Int?      @default(0)
  includes_content        Boolean?  @default(false)
  content_services        Json?     @db.JsonB
  includes_website        Boolean?  @default(false)
  website_services        Json?     @db.JsonB
  smart_rec_why_text      String?   // Default "why you need this" text for smart recommendations
  billing_term_months     Int?      // Number of months for term billing (null = ongoing, 12 = 12-month term)
  portal_slug             String?   // Unique slug used by the portal checkout system
  created_at              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at              DateTime? @default(now()) @db.Timestamptz(6)

  addon_products              addon_products[]
  bundle_products             bundle_products[]
  free_products               free_products[]
  product_dependencies        product_dependencies[] @relation("product")
  required_by                 product_dependencies[] @relation("requires")
  recommendation_items        recommendation_items[]
  smart_recommendation_items  smart_recommendation_items[]
  smart_recommendation_history smart_recommendation_history[]
  subscription_items          subscription_items[]
  checklist_templates         onboarding_checklist_templates[]
  question_templates          onboarding_question_templates[]
  client_products             client_products[]
}

model bundles {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  description       String?
  monthly_price     Decimal?  @db.Decimal
  onetime_price     Decimal?  @db.Decimal
  stripe_product_id String?
  stripe_price_id   String?
  status            String?   @default("active")
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  bundle_products      bundle_products[]
  recommendation_items recommendation_items[]
  subscription_items   subscription_items[]
}

model addons {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  description       String?
  price             Decimal   @db.Decimal
  stripe_product_id String?
  stripe_price_id   String?
  status            String?   @default("active")
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  addon_products       addon_products[]
  recommendation_items recommendation_items[]
}

model bundle_products {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bundle_id  String  @db.Uuid
  product_id String  @db.Uuid
  sort_order Int?    @default(0)

  bundle  bundles  @relation(fields: [bundle_id], references: [id])
  product products @relation(fields: [product_id], references: [id])
}

model addon_products {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  addon_id   String @db.Uuid
  product_id String @db.Uuid

  addon   addons   @relation(fields: [addon_id], references: [id])
  product products @relation(fields: [product_id], references: [id])
}

model product_dependencies {
  id                  String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id          String @db.Uuid
  requires_product_id String @db.Uuid

  product  products @relation("product", fields: [product_id], references: [id])
  requires products @relation("requires", fields: [requires_product_id], references: [id])
}

model free_products {
  id         String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id String @db.Uuid
  type       String

  product products @relation(fields: [product_id], references: [id])
}

// ============ Content Management ============

model content {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id        String    @db.Uuid
  title            String
  content_type     String?   // 'Blog Post', 'GBP Post', 'Service Page', 'Social Post', etc.
  platform         String?   // 'website', 'gbp', 'social', 'ai-creative'
  body             String?
  excerpt          String?   // Preview text
  status           String?   @default("draft")  // 'draft', 'pending_review', 'revision', 'approved', 'published'
  urgent           Boolean?  @default(false)
  deadline         DateTime? @db.Timestamptz(6)  // Review deadline
  author_id        String?   @db.Uuid
  assigned_to      String?   @db.Uuid
  due_date         DateTime? @db.Date
  scheduled_date   DateTime? @db.Timestamptz(6)  // When to publish
  published_at     DateTime? @db.Timestamptz(6)
  published_url    String?   // Live URL after publishing
  basecamp_todo_id String?

  // SEO fields (for blog/website content)
  target_keyword      String?
  secondary_keywords  String?
  word_count          Int?
  seo_optimized       Boolean?  @default(false)
  ai_optimized        Boolean?  @default(false)

  // Revision tracking
  revision_feedback   String?   // Client feedback when rejected
  revision_count      Int?      @default(0)

  // Workflow fields
  status_changed_at   DateTime? @default(now()) @db.Timestamptz(6)
  status_history      Json?     @default("[]")
  approval_required   Boolean?  @default(true)
  review_round        Int?      @default(0)
  featured_image      String?   // URL to featured image

  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  client            clients             @relation(fields: [client_id], references: [id])
  author            profiles?           @relation("content_author", fields: [author_id], references: [id])
  assignee          profiles?           @relation("content_assigned", fields: [assigned_to], references: [id])
  content_comments  content_comments[]
  content_revisions content_revisions[]

  @@index([client_id])
  @@index([status])
  @@index([platform])
}

model content_comments {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content_id  String    @db.Uuid
  user_id     String    @db.Uuid
  comment     String
  is_internal Boolean?  @default(false)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)

  content content  @relation(fields: [content_id], references: [id])
  user    profiles @relation(fields: [user_id], references: [id])
}

model content_revisions {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content_id     String    @db.Uuid
  body           String
  revision_notes String?
  created_by     String?   @db.Uuid
  created_at     DateTime? @default(now()) @db.Timestamptz(6)

  content content   @relation(fields: [content_id], references: [id])
  creator profiles? @relation(fields: [created_by], references: [id])
}

// ============ Recommendations ============

model recommendations {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id        String    @db.Uuid
  created_by       String?   @db.Uuid
  status           String?   @default("draft")
  pricing_type     String?
  total_monthly    Decimal?  @db.Decimal
  total_onetime    Decimal?  @db.Decimal
  discount_applied Decimal?  @default(0) @db.Decimal
  reward_tier_id   String?   @db.Uuid
  purchased_tier   String?   // 'good', 'better', 'best'
  purchased_at     DateTime? @db.Timestamptz(6)
  notes            String?
  sent_at          DateTime? @db.Timestamptz(6)
  responded_at     DateTime? @db.Timestamptz(6)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)
  archived_at      DateTime? @db.Timestamptz(6)

  client               clients                    @relation(fields: [client_id], references: [id])
  creator              profiles?                  @relation(fields: [created_by], references: [id])
  reward_tier          reward_tiers?              @relation(fields: [reward_tier_id], references: [id])
  recommendation_items recommendation_items[]
  recommendation_invites recommendation_invites[]
  subscriptions        subscriptions[]
  history              recommendation_history[]
}

model recommendation_history {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recommendation_id String    @db.Uuid
  action            String    // 'created', 'updated', 'sent', 'purchased', 'item_added', 'item_removed', 'tier_changed'
  details           String?   // JSON or text description of changes
  created_by        String?   @db.Uuid
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  recommendation recommendations @relation(fields: [recommendation_id], references: [id], onDelete: Cascade)
}

model recommendation_items {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recommendation_id String    @db.Uuid
  product_id        String?   @db.Uuid
  bundle_id         String?   @db.Uuid
  addon_id          String?   @db.Uuid
  tier              String?   // 'good', 'better', 'best'
  quantity          Int?      @default(1)
  monthly_price     Decimal?  @db.Decimal
  onetime_price     Decimal?  @db.Decimal
  is_free           Boolean?  @default(false)
  notes             String?
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  recommendation recommendations @relation(fields: [recommendation_id], references: [id])
  product        products?       @relation(fields: [product_id], references: [id])
  bundle         bundles?        @relation(fields: [bundle_id], references: [id])
  addon          addons?         @relation(fields: [addon_id], references: [id])
}

model recommendation_invites {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recommendation_id String    @db.Uuid
  first_name        String
  last_name         String
  email             String
  status            String?   @default("pending")
  invite_token      String?   @unique
  sent_at           DateTime? @db.Timestamptz(6)
  viewed_at         DateTime? @db.Timestamptz(6)
  responded_at      DateTime? @db.Timestamptz(6)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  recommendation recommendations @relation(fields: [recommendation_id], references: [id])
}

model reward_tiers {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  monthly_threshold   Decimal   @db.Decimal
  discount_percentage Int?      @default(0)
  coupon_code         String?
  free_product_slots  Int?      @default(0)
  sort_order          Int?      @default(0)
  created_at          DateTime? @default(now()) @db.Timestamptz(6)
  updated_at          DateTime? @default(now()) @db.Timestamptz(6)

  recommendations recommendations[]
}

// ============ Subscriptions ============

model subscriptions {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id              String    @db.Uuid
  recommendation_id      String?   @db.Uuid
  stripe_subscription_id String?   @unique
  stripe_customer_id     String?
  status                 String?
  current_period_start   DateTime? @db.Timestamptz(6)
  current_period_end     DateTime? @db.Timestamptz(6)
  monthly_amount         Decimal?  @db.Decimal
  created_at             DateTime? @default(now()) @db.Timestamptz(6)
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)

  client               clients                @relation(fields: [client_id], references: [id])
  recommendation       recommendations?       @relation(fields: [recommendation_id], references: [id])
  subscription_items   subscription_items[]
  subscription_history subscription_history[]
}

model subscription_items {
  id                          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subscription_id             String    @db.Uuid
  product_id                  String?   @db.Uuid
  bundle_id                   String?   @db.Uuid
  stripe_subscription_item_id String?
  quantity                    Int?      @default(1)
  unit_amount                 Decimal?  @db.Decimal
  term_end_date               DateTime? @db.Timestamptz(6) // For 12-month term products, when to cancel
  created_at                  DateTime? @default(now()) @db.Timestamptz(6)

  subscription subscriptions @relation(fields: [subscription_id], references: [id])
  product      products?     @relation(fields: [product_id], references: [id])
  bundle       bundles?      @relation(fields: [bundle_id], references: [id])
}

model subscription_history {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  subscription_id String    @db.Uuid
  action          String    // 'created', 'service_added', 'service_removed', 'billing_updated', 'status_changed'
  details         String?   // Description of changes
  created_by      String?   @db.Uuid
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  subscription subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)
}

// ============ Activity & Notifications ============

model activity_log {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id     String?   @db.Uuid
  user_id       String?   @db.Uuid
  activity_type String
  description   String?
  metadata      Json?
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  client clients?  @relation(fields: [client_id], references: [id])
  user   profiles? @relation(fields: [user_id], references: [id])
}

model notifications {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id    String    @db.Uuid
  title      String
  message    String?
  type       String?
  link       String?
  read_at    DateTime? @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  user profiles @relation(fields: [user_id], references: [id])
}

// ============ Revenue & Settings ============

model revenue_records {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id     String    @db.Uuid
  month         DateTime  @db.Date
  mrr           Decimal   @db.Decimal
  arr           Decimal?  @db.Decimal
  change_type   String?
  change_amount Decimal?  @db.Decimal
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id])
}

model role_permissions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  role       String   // 'super_admin', 'admin', 'production_team', 'sales'
  menu_key   String   // 'dashboard', 'recommendations', 'clients', etc.
  has_access Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  @@unique([role, menu_key])
  @@index([role])
}

model settings {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key        String    @unique
  value      Json?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  updated_at DateTime? @default(now()) @db.Timestamptz(6)
}

// ============ Onboarding ============

model onboarding_checklist_templates {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id                String    @db.Uuid
  title                     String
  description               String?
  action_type               String?   // 'link' | 'button' | 'auto'
  action_url                String?
  action_label              String?
  sort_order                Int       @default(0)
  is_active                 Boolean   @default(true)
  auto_complete_question_id String?   @db.Uuid  // Link to question that can auto-complete this item
  auto_complete_values      Json?     // Array of response values that trigger auto-complete (e.g., ["Yes", "yes"])
  created_at                DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                DateTime? @default(now()) @db.Timestamptz(6)

  product              products                       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  auto_complete_question onboarding_question_templates? @relation(fields: [auto_complete_question_id], references: [id], onDelete: SetNull)
  client_completions   client_checklist_items[]
}

model client_checklist_items {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id    String    @db.Uuid
  template_id  String    @db.Uuid
  is_completed Boolean   @default(false)
  completed_at DateTime? @db.Timestamptz(6)
  completed_by String?   @db.Uuid
  notes        String?
  created_at   DateTime? @default(now()) @db.Timestamptz(6)

  client   clients                        @relation(fields: [client_id], references: [id], onDelete: Cascade)
  template onboarding_checklist_templates @relation(fields: [template_id], references: [id], onDelete: Cascade)

  @@unique([client_id, template_id])
}

model onboarding_question_templates {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product_id    String    @db.Uuid
  question_text String
  question_type String    // 'text' | 'textarea' | 'select' | 'multiselect' | 'radio' | 'checkbox' | 'url' | 'email' | 'phone'
  options       Json?     // For select/multiselect/radio
  placeholder   String?
  help_text     String?
  video_url     String?   // Optional help video embed URL (Loom, YouTube, Vimeo, etc.)
  image_url     String?   // Optional help image URL
  is_required   Boolean   @default(false)
  section       String?   // Grouping: "Business Info", "Website Design", etc.
  sort_order    Int       @default(0)
  is_active     Boolean   @default(true)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)
  updated_at    DateTime? @default(now()) @db.Timestamptz(6)

  product             products                         @relation(fields: [product_id], references: [id], onDelete: Cascade)
  responses           client_onboarding_responses[]
  linked_checklists   onboarding_checklist_templates[]
}

model client_onboarding_responses {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id        String    @db.Uuid
  question_id      String    @db.Uuid
  response_text    String?
  response_options Json?
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  updated_at       DateTime? @default(now()) @db.Timestamptz(6)

  client   clients                       @relation(fields: [client_id], references: [id], onDelete: Cascade)
  question onboarding_question_templates @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@unique([client_id, question_id])
}

// ============ Communications ============

model client_communications {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id        String    @db.Uuid
  // Communication type: 'email_invite', 'email_reminder', 'email_general', 'result_alert',
  // 'chat', 'monthly_report', 'content_approval', 'task_complete', 'meeting', 'call'
  comm_type        String
  // Title/subject of the communication
  title            String
  // Optional subject line (for emails)
  subject          String?
  // Body content or description
  body             String?
  // Delivery status: 'sent', 'delivered', 'opened', 'clicked', 'failed', 'bounced'
  status           String?   @default("sent")
  // For result alerts - extra data like keyword position, traffic milestone
  metadata         Json?
  // Whether this is a highlight (success or failure)
  highlight_type   String?   // 'success' | 'failed' | null
  // Recipient email (for emails)
  recipient_email  String?
  // When the communication was opened/viewed
  opened_at        DateTime? @db.Timestamptz(6)
  // When a link was clicked
  clicked_at       DateTime? @db.Timestamptz(6)
  // When it was sent
  sent_at          DateTime? @default(now()) @db.Timestamptz(6)
  // Who created/sent this communication
  created_by       String?   @db.Uuid
  created_at       DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)
}

model onboarding_video_chapters {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  description String?
  video_url   String?
  sort_order  Int       @default(0)
  is_active   Boolean   @default(true)
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
}

// ============ Basecamp Integration ============

model basecamp_activities {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id             String?   @db.Uuid
  kind                  String    // 'todo_created', 'todo_completed'
  basecamp_request_id   String?   // webhook request id
  task_id               String    // basecamp todo id
  project_id            String?   // basecamp project/bucket id
  project_title         String?
  recording_status      String?   // 'active', 'completed', etc.
  recording_title       String?   // todo title
  recording_type        String?   // 'Todo'
  recording_position    Int?      @default(0)
  parent_id             String?   // todolist id
  parent_title          String?   // todolist name
  parent_type           String?   // 'Todolist'
  recording_content     String?   // todo description/content
  basecamp_created_at   DateTime? @db.Timestamptz(6)
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)

  client clients? @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([task_id])
  @@index([client_id])
  @@index([project_id])
}

// ============ Website Edit Requests ============

model website_edit_requests {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id    String    @db.Uuid
  title        String
  description  String?
  request_type String    // 'content_update', 'new_feature', 'bug_fix', 'design_change'
  status       String    @default("pending") // 'pending', 'in-progress', 'completed', 'cancelled'
  priority     String?   @default("normal") // 'low', 'normal', 'high', 'urgent'
  completed_at DateTime? @db.Timestamptz(6)
  created_by   String?   @db.Uuid
  created_at   DateTime? @default(now()) @db.Timestamptz(6)
  updated_at   DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([status])
}

// ============ Smart Recommendations ============

model smart_recommendations {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id       String    @db.Uuid
  status          String    @default("draft") // 'draft', 'published', 'archived'
  published_at    DateTime? @db.Timestamptz(6)
  next_refresh_at DateTime? @db.Timestamptz(6) // published_at + 90 days
  created_by      String?   @db.Uuid
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  client  clients                        @relation(fields: [client_id], references: [id], onDelete: Cascade)
  items   smart_recommendation_items[]
  history smart_recommendation_history[]

  @@index([client_id])
  @@index([status])
}

model smart_recommendation_items {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recommendation_id   String    @db.Uuid
  product_id          String    @db.Uuid
  priority            Int       @default(1) // Display order (1 = top)
  why_note            String?   // Admin's "why you need it" explanation
  is_featured         Boolean   @default(false) // Highlight as top recommendation
  price_option        String?   @db.VarChar(20) // 'monthly' | 'onetime' | 'client_choice' | null (auto-detect)
  coupon_code         String?   @db.VarChar(50) // Stripe coupon/promo code to auto-apply at checkout
  status              String    @default("active") @db.VarChar(20) // 'active', 'purchased', 'declined'
  status_changed_at   DateTime? @db.Timestamptz(6)
  status_changed_by   String?   @db.Uuid
  created_at          DateTime? @default(now()) @db.Timestamptz(6)
  updated_at          DateTime? @default(now()) @db.Timestamptz(6)

  recommendation smart_recommendations          @relation(fields: [recommendation_id], references: [id], onDelete: Cascade)
  product        products                       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  history        smart_recommendation_history[]

  @@index([recommendation_id])
  @@index([product_id])
  @@index([status])
}

model smart_recommendation_history {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recommendation_id String    @db.Uuid
  item_id           String?   @db.Uuid
  product_id        String?   @db.Uuid
  action            String    @db.VarChar(50) // 'item_added', 'item_removed', 'declined', 'purchased', 'published', 'archived'
  details           String?
  created_by        String?   @db.Uuid
  created_at        DateTime? @default(now()) @db.Timestamptz(6)

  recommendation smart_recommendations       @relation(fields: [recommendation_id], references: [id], onDelete: Cascade)
  item           smart_recommendation_items? @relation(fields: [item_id], references: [id], onDelete: SetNull)
  product        products?                   @relation(fields: [product_id], references: [id], onDelete: SetNull)

  @@index([recommendation_id])
  @@index([item_id])
}

// ============ Performance Scoring ============

model metric_snapshots {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id    String    @db.Uuid
  metric_type  String    // 'visitors', 'keyword_avg_position', 'leads', 'ai_visibility', 'conversions'
  value        Decimal   @db.Decimal
  period_start DateTime  @db.Date
  period_end   DateTime  @db.Date
  created_at   DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([metric_type])
  @@index([period_start])
}

model keyword_rankings {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id     String    @db.Uuid
  keyword       String
  position      Int
  search_engine String    // 'google', 'bing', 'chatgpt', 'perplexity', 'gemini', 'copilot'
  recorded_at   DateTime  @db.Timestamptz(6)
  created_at    DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([keyword])
  @@index([recorded_at])
}

model leads {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id  String    @db.Uuid
  source     String    // 'organic', 'paid', 'referral', 'direct', 'social'
  lead_score Int?      // Optional quality score 1-100
  converted  Boolean?  @default(false)
  metadata   Json?     // Additional lead data (name, email, etc.)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([source])
  @@index([created_at])
}

model ai_visibility_scores {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id        String    @db.Uuid
  platform         String    // 'chatgpt', 'perplexity', 'gemini', 'copilot', 'claude'
  query            String
  visibility_score Int       // Score 0-100
  mentioned        Boolean?  @default(false)
  position         Int?      // Position in AI response (if listed)
  recorded_at      DateTime  @db.Timestamptz(6)
  created_at       DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([platform])
  @@index([recorded_at])
}

model client_alerts {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id    String    @db.Uuid
  message      String
  alert_type   String    // 'performance_focus', 'general_update', 'milestone', 'intervention'
  status       String?   @default("draft") // 'draft', 'published', 'dismissed'
  published_at DateTime? @db.Timestamptz(6)
  dismissed_at DateTime? @db.Timestamptz(6)
  created_by   String?   @db.Uuid
  created_at   DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([status])
}

model score_history {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id    String    @db.Uuid
  score        Int       // Performance score 0-100
  growth_stage String?   // Growth stage at time of recording
  recorded_at  DateTime  @default(now()) @db.Timestamptz(6)
  created_at   DateTime? @default(now()) @db.Timestamptz(6)

  client clients @relation(fields: [client_id], references: [id], onDelete: Cascade)

  @@index([client_id])
  @@index([recorded_at])
}

model system_alerts {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  severity    String
  category    String
  message     String
  metadata    Json      @default("{}")
  source_file String?
  client_id   String?   @db.Uuid
  user_id     String?   @db.Uuid
  resolved_at DateTime? @db.Timestamptz(6)
  created_at  DateTime  @default(now()) @db.Timestamptz(6)

  client clients? @relation(fields: [client_id], references: [id])

  @@index([severity])
  @@index([category])
  @@index([created_at(sort: Desc)])
  @@index([client_id])
}
